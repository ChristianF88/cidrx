#################################################################################
# cidrx Configuration Example                                                   #
# This is a comprehensive example configuration file for the cidrx tool.       #
#                                                                               #
# cidrx supports two main modes:                                               #
# 1. STATIC MODE: Analyze existing log files for threat patterns               #
# 2. LIVE MODE: Real-time analysis with sliding window detection               #
#                                                                               #
# Key Features:                                                                 #
# - IP-based clustering and threat detection                                   #
# - User-Agent based whitelisting/blacklisting                                 #
# - CIDR-based IP filtering                                                    #
# - Flexible log format parsing                                                #
# - Jail system for ban management                                             #
# - Multiple analysis tries per mode                                           #
#################################################################################

[global]
# REQUIRED: Core jail and ban file configuration
# These files are used by both static and live modes
jailFile = "/tmp/cidrx_jail.json"        # Jail state persistence file
banFile = "/tmp/cidrx_ban.txt"           # Output file for banned IPs/CIDRs

# OPTIONAL: Whitelist and blacklist files for IP filtering
# Relative paths are supported and recommended for portability
whitelist = "config_examples/whitelist.txt"              # Optional: IPs/CIDRs never to ban
blacklist = "config_examples/blacklist.txt"              # Optional: IPs/CIDRs always to ban

# OPTIONAL: User-Agent based filtering
# These files contain substrings to match against User-Agent headers
userAgentWhitelist = "config_examples/ua_whitelist.txt"  # Optional: User-Agent patterns that whitelist IPs
userAgentBlacklist = "config_examples/ua_blacklist.txt"  # Optional: User-Agent patterns that blacklist IPs

# WHITELIST/BLACKLIST BEHAVIOR:
# 1. IP Whitelist: IPs matching these CIDRs are never added to jail
# 2. IP Blacklist: IPs matching these CIDRs are always added to ban file
# 3. User-Agent Whitelist: IPs with these UA patterns are excluded from analysis
# 4. User-Agent Blacklist: IPs with these UA patterns are immediately banned
# 5. Processing order: UA filters → IP filters → clustering → jail → ban file

#################################################################################
# STATIC MODE CONFIGURATION                                                     #
# Used for analyzing existing log files                                        #
#################################################################################

[static]
# REQUIRED: Log file and format configuration
logFile = "/path/to/your/access.log"     # Path to log file to analyze
plotPath = "/tmp/cidrx_heatmap.html"     # Optional: Generate visual heatmap

# LOG FORMAT CONFIGURATION
# Define how to parse your log files using format specifiers
# This is crucial for proper IP extraction and analysis
#
# AVAILABLE FIELD SPECIFIERS:
#   %h  - IP address (EXACTLY ONE REQUIRED)
#   %t  - Timestamp [DD/MMM/YYYY:HH:MM:SS +ZZZZ]
#   %r  - Full HTTP request line "METHOD URI VERSION" (QUOTED only)
#   %m  - HTTP method standalone (GET, POST, etc.)
#   %U  - URI path standalone (/path/to/resource)
#   %s  - HTTP status code (200, 404, etc.)
#   %b  - Response bytes sent
#   %u  - User-Agent string
#   %^  - Skip/ignore this field
#
# VALIDATION RULES:
#   - Exactly ONE %h field is required
#   - Other fields can appear at most once (except %^)
#   - Use %^ to skip unwanted fields
#   - Supported fields only: %h %t %r %m %U %s %b %u %^
#
# CRITICAL: %r vs %m %U %^ Usage:
#   - Use %r ONLY for QUOTED request lines: "GET /path HTTP/1.1"
#   - Use %m %U %^ ONLY for SEPARATE unquoted fields: GET /path HTTP/1.1
#   - Wrong choice = parsing failures!
#
# COMMON LOG FORMAT EXAMPLES:

# Apache Combined with X-Forwarded-For (real client IP at end):
logFormat = "%^ %^ %^ [%t] \"%r\" %s %b %^ \"%u\" \"%h\""

# Standard Apache Combined Log:
# logFormat = "%h %^ %^ [%t] \"%r\" %s %b %^ \"%u\""

# Apache Common Log:
# logFormat = "%h %^ %^ [%t] \"%r\" %s %b"

# Nginx Default Access Log:
# logFormat = "%h %^ %^ [%t] \"%r\" %s %b %^ \"%u\""

# Custom Format Examples with %r (quoted request):
# logFormat = "%h [%t] \"%r\" %s %b"                   # Basic quoted request format
# logFormat = "%h %^ [%t] \"%r\" %s %b \"%u\""         # Skip user field, quoted request
# logFormat = "%^ %^ %h [%t] \"%r\" %s %b"             # Skip first two fields, quoted request

# Custom Format Examples with %m %U %^ (separate fields):
# logFormat = "%h [%t] %m %U %^ %s %b"                 # Separate method/URI/version fields
# logFormat = "%h %^ [%t] %m %U %^ %s %b \"%u\""       # Skip user field, separate method/URI
# logFormat = "%^ %^ %h [%t] %m %U %^ %s %b"           # Skip first two fields, separate method/URI

#################################################################################
# STATIC MODE ANALYSIS TRIES                                                   #
# Each trie can have different filters and clustering parameters               #
#################################################################################

[static.trie_1]
# DESCRIPTION: General threat detection - analyze all traffic
# This trie processes all requests without filters for broad threat detection

# OPTIONAL: Request filtering
# useragentRegex = ".*bot.*"           # Only analyze requests matching this UA regex
# endpointRegex = "/api/.*"            # Only analyze requests to endpoints matching this regex

# OPTIONAL: Time range filtering
# startTime = "2024-01-01T00:00:00Z"   # Start time (RFC3339 format)
# endTime = "2024-12-31T23:59:59Z"     # End time (RFC3339 format)

# OPTIONAL: CIDR range analysis
# Analyze request distribution within specific network ranges
cidrRanges = ["10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]

# REQUIRED: Clustering configuration
# Each array defines one clustering analysis: [minClusterSize, minDepth, maxDepth, meanSubnetDifference]
# - minClusterSize: Minimum IPs needed to form a cluster
# - minDepth: Minimum subnet depth to consider (e.g., 24 for /24 networks)
# - maxDepth: Maximum subnet depth to consider (e.g., 32 for individual IPs)
# - meanSubnetDifference: Threshold for grouping similar subnets
clusterArgSets = [
    [1000, 16, 24, 0.2],    # Large clusters: 1000+ IPs, /16 to /24 networks
    [500, 20, 28, 0.15],    # Medium clusters: 500+ IPs, /20 to /28 networks
    [100, 24, 32, 0.1]      # Small clusters: 100+ IPs, /24 to /32 (individual IPs)
]

# REQUIRED: Jail configuration
# Specify which clustering results should contribute to the jail
# Must match the number of clusterArgSets entries
useForJail = [true, true, false]    # Use first two cluster results for jail

[static.trie_2]
# DESCRIPTION: Admin endpoint security - focus on sensitive areas
# This trie focuses on administrative and sensitive endpoints

# Filter for administrative endpoints
endpointRegex = "/(admin|api|dashboard|login|auth|config|setup|install).*"

# Analyze traffic to admin endpoints
cidrRanges = ["192.168.0.0/16"]          # Analyze all IP ranges

# More aggressive clustering for admin endpoints
clusterArgSets = [
    [50, 24, 32, 0.05],     # Very sensitive: 50+ IPs, /24 to /32
    [20, 28, 32, 0.03],     # Highly sensitive: 20+ IPs, /28 to /32
    [10, 30, 32, 0.02]      # Extremely sensitive: 10+ IPs, /30 to /32
]

# All admin endpoint clusters go to jail
useForJail = [true, true, true]

[static.trie_3]
# DESCRIPTION: Suspicious User-Agent detection
# This trie focuses on detecting automated tools and suspicious clients

# Filter for potentially malicious user agents
useragentRegex = ".*(bot|crawler|spider|scraper|scan|hack|exploit|attack|curl|wget|python|php).*"

# Time-based analysis (example: analyze last 24 hours)
# startTime = "2024-07-15T00:00:00Z"
# endTime = "2024-07-16T00:00:00Z"

# Analyze all networks for suspicious UAs
cidrRanges = ["0.0.0.0/0"]

# Moderate clustering for suspicious UAs
clusterArgSets = [
    [200, 20, 28, 0.1],     # Medium clusters: 200+ IPs
    [100, 24, 32, 0.08],    # Small clusters: 100+ IPs
    [50, 28, 32, 0.05]      # Very small clusters: 50+ IPs
]

# Use all suspicious UA clusters for jail
useForJail = [true, true, true]

#################################################################################
# LIVE MODE CONFIGURATION                                                      #
# Used for real-time analysis with sliding window detection                    #
#                                                                               #
# ARCHITECTURE: Each [live.X] section creates an INDEPENDENT sliding window   #
# This allows different time ranges and parameters for different threat types #
#################################################################################

[live]
# REQUIRED: Network configuration (global settings only)
port = "8080"                           # Port to listen for incoming log streams

# NOTE: Sliding window parameters are now per-window, not global
# Each [live.X] section below defines its own sliding window

[live.sliding_trie_1]
# DESCRIPTION: Real-time general threat detection
# This creates an INDEPENDENT sliding window for broad threat detection

# REQUIRED: Sliding window configuration for this window
slidingWindowMaxTime = "2h"             # How long to retain data in THIS window
slidingWindowMaxSize = 100000           # Maximum entries in THIS window
sleepBetweenIterations = 10             # Seconds between analysis iterations

# OPTIONAL: Request filtering
# useragentRegex = ".*scanner.*"        # Only analyze requests matching this UA regex
# endpointRegex = "/api/.*"             # Only analyze requests to endpoints matching this regex

# REQUIRED: Real-time clustering configuration
clusterArgSets = [
    [500, 16, 24, 0.2],     # Medium clusters for real-time
    [200, 20, 28, 0.15],    # Smaller clusters for faster detection
    [100, 24, 32, 0.1]      # Individual IP detection
]

# REQUIRED: Real-time jail configuration
useForJail = [true, true, false]

[live.sliding_trie_2]
# DESCRIPTION: High-frequency attack detection
# This creates a SEPARATE independent sliding window with different parameters

# REQUIRED: Sliding window configuration for this window
# Note: Different time window than sliding_trie_1 for faster threat detection
slidingWindowMaxTime = "30m"            # Shorter window for rapid detection
slidingWindowMaxSize = 20000            # Smaller window for faster processing
sleepBetweenIterations = 5              # More frequent analysis

# OPTIONAL: Filter for high-frequency attack patterns
useragentRegex = ".*(scan|attack|brute|force|exploit).*"
endpointRegex = "/(login|admin|wp-admin|phpmyadmin).*"

# REQUIRED: Aggressive clustering for rapid threats
clusterArgSets = [
    [100, 20, 28, 0.08],    # Quick cluster detection
    [50, 24, 32, 0.05],     # Individual IP detection
    [25, 28, 32, 0.03]      # Very sensitive detection
]

# REQUIRED: All rapid threat clusters go to jail
useForJail = [true, true, true]

#################################################################################
# CONFIGURATION TIPS AND BEST PRACTICES                                        #
#################################################################################

# PERFORMANCE OPTIMIZATION:
# 1. Use appropriate clusterArgSets for your dataset size
# 2. Larger minClusterSize values are faster but less sensitive
# 3. Narrower depth ranges (e.g., 24-28) are faster than wide ranges (e.g., 16-32)
# 4. Use time filtering to reduce dataset size when possible
# 5. Consider using multiple tries with different sensitivity levels

# SECURITY CONSIDERATIONS:
# 1. Always maintain an IP whitelist for essential services
# 2. Test blacklist patterns before deployment
# 3. Monitor jail file size and rotation
# 4. Use specific User-Agent patterns to avoid false positives
# 5. Regularly review and update filtering rules

# OPERATIONAL NOTES:
# 1. The jail file persists banned IPs across restarts
# 2. The ban file is generated fresh each run
# 3. Relative paths are resolved from the config file location
# 4. Log rotation requires restarting the analysis
# 5. Monitor system resources with large datasets

# TROUBLESHOOTING:
# 1. Verify log format with sample entries
# 2. Check file permissions for all referenced files
# 3. Monitor log output for parsing errors
# 4. Test regex patterns with sample data
# 5. Validate CIDR ranges and time formats
